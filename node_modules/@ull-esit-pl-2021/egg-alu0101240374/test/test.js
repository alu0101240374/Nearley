let fs = require('fs');
let should = require('chai').should();
let e2t = require('@ull-esit-pl/example2test');
let eggvm = require('../lib/eggvm.js');

const TESTS = [
  'one', 'scope', 'arithmetic', 'array', 'expcomma', 'fun', 'if',
  'string', 'sum', 'two', 'bracket-array', 'brackets-fun', 'bracket-expcomma', 'multiline-comment',
  'fun-set-alias', 'element-define-alias', 'reto'
];

describe("Console.log Stubbing", function() {
  let originalLog;
  let output = [];

  let tests = new Map();

  tests.set('test/examples/for-each.egg', [1, 2, 3, '"A"', '"B"', '"C"']);
  tests.set('test/examples/forEach-objects.egg', [4, 3, 2, 1]);
  tests.set('test/examples/for.egg', [0, 1, 2, 3, 4]);
  tests.set('test/examples/client.egg', ['"inside module"', 5]);
  tests.set('test/examples/dot-num.egg', ['4.00', '4.00', '4.00']);
  // tests.set('test/examples/dot-object.egg', [0, 0, 0,]);
  tests.set('test/examples/objects.egg', [0, 4, 5, 5]);
  tests.set('test/examples/sub.egg', [1, 5, 3, 4]);
  //tests.set('test/examples/map.egg', [{ x: 4, y: { z: 3 } }]);
  tests.set('test/examples/set-array.egg', [[1, 2, 9, [ 9, 1000, 7]], [1, 2, 9, [9, 1000, 7]]]); //como se guarda en outputs por referencia, al cambiar el array tambÃ­en se cambia en output
  tests.set('test/examples/multiple-indexes.egg', [1, [2, 3], 3, 3, 2]);
  tests.set('test/examples/negative-index.egg', [[2, 3]]);
  tests.set('test/examples/one.egg', [50]);
  tests.set('test/examples/two.egg', [4, 6]);
  tests.set('test/examples/scope-err.egg', ReferenceError);
  tests.set('test/examples/concatenate-methods.egg', ["\"A\"\"-\"\"B\"\"-\"\"C\""]);
  tests.set('test/examples/concatenate-methods-v2.egg', ["1\"-\"hello egg\""]);
  tests.set('test/examples/array-index.egg', [1, [5, 3], 3]);
  tests.set('test/examples/map-inc.egg', [[2, 3, 4, 5]]);
  tests.set('test/examples/join.egg', ["1\"-\"4\"-\"5"]);
  tests.set('test/examples/to-upper-case.egg', ["\"HELLO\""]);
  tests.set('test/examples/monkey-patch-+.egg', [18]);
  tests.set('test/examples/monke.egg', ["This is monkey-patching"]);

  beforeEach(function() {
    originalLog = console.log;
    console.log = function (...args) { 
      originalLog(...args); 
      output.push(...args);
      return args;
    };
  });
  
  afterEach(function() {
    console.log = originalLog;
    output = [];
  });

  tests.forEach ((result, file) => {
    it("Trying " + file, function() {
      let program = fs.readFileSync(file, 'utf8');
      if (result instanceof Array) {
        let r = eggvm.run(program);
        for (let i = 0; i < output.length; i++) {
          output[i].should.eql(result[i]);
        }
      } else {
        (() => { eggvm.run(program); }).should.throw(result);
      }
    });
  });
});

describe("Testing without stubbing", function() {
  let runTest = (programName, done) => {
    e2t({
      exampleInput: programName + '.egg',
      executable: 'node bin/egg.js',
      assertion: (result, expected) => result.replace(/\s+/g,'').should.eql(expected.replace(/\s+/g,'')),
      done: done,
    });
  };

  it("should not allow the use of non declared variables", function() {
    let program = fs.readFileSync('examples/scope-err.egg', 'utf8');
    (() => { eggvm.run(program); }).should.throw(/setting.+undefined.+variable/i);
  });

  it("Number as fun error", function() {
    let program = fs.readFileSync('test/examples/number-as-fun-err.egg', 'utf8');
    (() => { eggvm.run(program); }).should.throw(/.*unexpected input.*/i);
  });

  for (let test of TESTS) {
    it(`testing ${test}.egg`, function(done) {
      runTest(test, done);
    });
  }
});

describe("Testing evm", function() {
  let runTest = (programName, done) => {
    e2t({
      exampleInput: programName,
      executable: 'node bin/evm.js',
      assertion: (result, expected) => result.replace(/\s+/g,'').should.eql(expected.replace(/\s+/g,'')),
      done: done,
    });
  };

  it(`testing one.egg.evm`, function(done) {
    runTest('one.egg.evm', done);
  });
});